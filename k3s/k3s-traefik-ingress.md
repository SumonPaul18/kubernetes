# ЁЯУШ **рж╕ржорзНржкрзВрж░рзНржг ржЧрж╛ржЗржб: k3s-ржП Traefik рж╕ржХрзНрж░рж┐ржпрж╝ ржХрж░рж╛, рж╕ржорж╕рзНржпрж╛ рж╕ржорж╛ржзрж╛ржи ржУ IP-ржнрж┐рждрзНрждрж┐ржХ Ingress рж╕рзЗржЯржЖржк**

> **рж▓ржХрзНрж╖рзНржп**:  
> - k3s ржХрзНрж▓рж╛рж╕рзНржЯрж╛рж░рзЗ **Traefik ржХрзЗ ржбрж┐ржлрж▓рзНржЯ Ingress Controller** рж╣рж┐рж╕рзЗржмрзЗ рж╕ржХрзНрж░рж┐ржпрж╝ рж░рж╛ржЦрж╛  
> - `helm-install-traefik` Job-ржПрж░ **CrashLoopBackOff** рж╕ржорж╛ржзрж╛ржи  
> - **IP ржжрж┐ржпрж╝рзЗ рж╕рж░рж╛рж╕рж░рж┐ ржмрзНрж░рж╛ржЙржЬ** ржХрж░рж╛рж░ ржмрзНржпржмрж╕рзНржерж╛ ржХрж░рж╛ (ржбрзЛржорзЗржЗржи ржЫрж╛ржбрж╝рж╛)

---

## ЁЯФз ржкрж░рзНржпрж╛ржпрж╝ рзз: рж╕ржорж╕рзНржпрж╛ ржЪрж┐рж╣рзНржирж┐рждржХрж░ржг

ржЖржкржирж╛рж░ ржкрзНрж░рж╛ржержорж┐ржХ ржЕржмрж╕рзНржерж╛:

```bash
kubectl get pods -A
```

тЖТ `helm-install-traefik-*` pods **CrashLoopBackOff** ржЕржмрж╕рзНржерж╛ржпрж╝  
тЖТ рж▓ржЧ ржжрзЗржЦрж╛ржпрж╝:

```
Error: failed to fetch https://10.43.0.1:443/static/charts/... : 404 Not Found
```

**рж╕ржорж╕рзНржпрж╛**:  
k3s-ржПрж░ built-in static chart server ржерзЗржХрзЗ Traefik chart ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржЪрзНржЫрзЗ ржирж╛ тАФ рж╕ржорзНржнржмржд ржХрж░рж╛ржкрзНржЯрзЗржб/ржЕрж╕ржорзНржкрзВрж░рзНржг ржЗржирж╕рзНржЯрж▓рзЗрж╢ржиред

ржЖржкржирж╛рж░ ржирзЛржб ржЫрж┐рж▓ **single-node k3s server** (`systemctl is-active k3s` тЖТ `active`, `ps aux` тЖТ `k3s server`).

---

## ЁЯФД ржкрж░рзНржпрж╛ржпрж╝ рзи: ржХрзНрж▓рж┐ржи рж╕рзНржЯрзЗржЯ рждрзИрж░рж┐ (k3s рж░рж┐-ржЗржирж╕рзНржЯрж▓)

### 1. k3s ржЖржиржЗржирж╕рзНржЯрж▓ ржХрж░рзБржи

```bash
sudo systemctl stop k3s
sudo /usr/local/bin/k3s-uninstall.sh 2>/dev/null || true
sudo rm -rf /etc/rancher/k3s /var/lib/rancher/k3s
sudo rm -f /usr/local/bin/k3j3s /etc/systemd/system/k3s.service
sudo systemctl daemon-reload
```

### 2. ржЕржлрж┐рж╕рж┐ржпрж╝рж╛рж▓ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржжрж┐ржпрж╝рзЗ ржирждрзБржи ржХрж░рзЗ ржЗржирж╕рзНржЯрж▓ ржХрж░рзБржи

```bash
curl -sfL https://get.k3s.io | sh -
```

> тЬЕ ржПржЯрж┐ **Traefik рж╕ржХрзНрж░рж┐ржпрж╝ рж░рж╛ржЦржмрзЗ** (ржХрзЛржирзЛ `--disable traefik` ржЫрж╛ржбрж╝рж╛)

### 3. kubeconfig ржарж┐ржХ ржХрж░рзБржи

```bash
export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
# ржЕржержмрж╛
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
```

### 4. ржнрзЗрж░рж┐ржлрж╛ржЗ ржХрж░рзБржи

```bash
kubectl get nodes
kubectl get pods -n kube-system | grep traefik
```

тЬЕ ржЖржЙржЯржкрзБржЯ:

- `helm-install-traefik-*` тЖТ **Completed**  
- `traefik-xxxxx` тЖТ **Running**  
- `svclb-traefik-xxxxx` тЖТ **Running** (k3s Service LoadBalancer)

---

## ЁЯзк ржкрж░рзНржпрж╛ржпрж╝ рзй: ржЯрзЗрж╕рзНржЯ ржЕрзНржпрж╛ржк ржбрж┐ржкрзНрж▓ржпрж╝ ржХрж░рзБржи

```bash
kubectl create deploy nginx-deploy --image=nginx --port=80
kubectl expose deploy nginx-deploy --port=80
```

---

## ЁЯМР ржкрж░рзНржпрж╛ржпрж╝ рзк: IP-ржнрж┐рждрзНрждрж┐ржХ Ingress рж╕рзЗржЯржЖржк (ржбрзЛржорзЗржЗржи ржЫрж╛ржбрж╝рж╛)

### 1. рж╕ржарж┐ржХ `ip-ingress.yaml` рждрзИрж░рж┐ ржХрж░рзБржи

```yaml
# ip-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
meta
  name: ip-based-ingress
  namespace: default
spec:
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nginx-deploy
                port:
                  number: 80
```

> тЪая╕П **ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг**:  
> - `rules` ржПрж░ ржкрж░рзЗ `- http:` (рж▓рж┐рж╕рзНржЯ ржЖржЗржЯрзЗржо)  
> - `host` ржлрж┐рж▓рзНржб ржирзЗржЗ тЖТ ржпрзЗржХрзЛржирзЛ IP-ржП ржХрж╛ржЬ ржХрж░ржмрзЗ

### 2. Apply ржХрж░рзБржи

```bash
kubectl apply -f ip-ingress.yaml
```

### 3. ржнрзЗрж░рж┐ржлрж╛ржЗ ржХрж░рзБржи

```bash
kubectl get ingress
# NAME               CLASS     HOSTS   ADDRESS         PORTS   AGE
# ip-based-ingress   traefik   *       192.168.0.41    80      5s
```

### 4. ржмрзНрж░рж╛ржЙржЬ ржХрж░рзБржи

```text
http://<ржЖржкржирж╛рж░_k8sworker_ржПрж░_IP>
ржЙржжрж╛рж╣рж░ржг: http://192.168.0.41
```

тЬЕ Nginx welcome page ржжрзЗржЦрж╛ржирзЛ ржЙржЪрж┐ржд тАФ **ржХрзЛржирзЛ `/etc/hosts` ржкрж░рж┐ржмрж░рзНрждржи ржЫрж╛ржбрж╝рж╛ржЗ**ред

---

## ЁЯЫая╕П ржЯрзНрж░рж╛ржмрж▓рж╢рзБржЯрж┐ржВ рж░рзЗржлрж╛рж░рзЗржирзНрж╕

| рж╕ржорж╕рзНржпрж╛ | рж╕ржорж╛ржзрж╛ржи |
|--------|--------|
| `404 Not Found` on chart URL | k3s рж░рж┐-ржЗржирж╕рзНржЯрж▓ ржХрж░рзБржи (ржЕржлрж┐рж╕рж┐ржпрж╝рж╛рж▓ рж╕рзНржХрзНрж░рж┐ржкрзНржЯ ржжрж┐ржпрж╝рзЗ) |
| `x509: certificate signed by unknown authority` | `export KUBECONFIG=/etc/rancher/k3s/k3s.yaml` |
| Ingress apply error: `cannot restore slice from map` | YAML-ржП `rules`-ржП `- http:` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи (рж▓рж┐рж╕рзНржЯ ржлрж░ржорзНржпрж╛ржЯ) |
| Traefik Job ржЖржмрж╛рж░ ржЖрж╕рзЗ | `/etc/rancher/k3s/config.yaml`-ржП `disable: - traefik` ржерж╛ржХрж▓рзЗ ржорзБржЫрзБржи |

---

## тЬЕ ржЪрзВржбрж╝рж╛ржирзНржд рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕

- тЬЕ k3s ржХрзНрж▓рж╛рж╕рзНржЯрж╛рж░: **рж╕рзНржерж┐рждрж┐рж╢рзАрж▓, рж╕рж┐ржЩрзНржЧрзЗрж▓-ржирзЛржб**
- тЬЕ Traefik: **ржбрж┐ржлрж▓рзНржЯ Ingress Controller**, рж╕ржХрзНрж░рж┐ржпрж╝
- тЬЕ Ingress: **IP-ржнрж┐рждрзНрждрж┐ржХ**, ржбрзЛржорзЗржЗржи ржЫрж╛ржбрж╝рж╛ ржХрж╛ржЬ ржХрж░рзЗ
- тЬЕ ржЕрзНржпрж╛ржк: **nginx-deploy**, Traefik ржжрж┐ржпрж╝рзЗ ржПржХрзНрж╕ржкрзЛржЬржб

---

## ЁЯМ┐ рж╢рзЗрж╖ ржХржерж╛

ржЖржкржирж┐ рж╢рзБржзрзБ ржПржХржЯрж┐ ржкрзНрж░ржмрж▓рзЗржо рж╕рж▓ржн ржХрж░рзЗржиржирж┐ тАФ  
ржЖржкржирж┐ **ржПржХржЯрж┐ рж╕рзНржерж┐рждрж┐рж╢рзАрж▓, ржмрзНржпржмрж╣рж╛рж░ржпрзЛржЧрзНржп k3s + Traefik рж▓рзНржпрж╛ржм** рждрзИрж░рж┐ ржХрж░рзЗржЫрзЗржи,  
ржпрзЗржЦрж╛ржирзЗ ржкрзНрж░рждрж┐ржЯрж┐ ржХржорзНржкрзЛржирзЗржирзНржЯрзЗрж░ ржЙрзОржкрждрзНрждрж┐, рж╕ржорзНржкрж░рзНржХ ржУ ржирж┐ржпрж╝ржирзНрждрзНрж░ржг ржЖржкржирж╛рж░ рж╣рж╛рждрзЗред

> ЁЯРз ржПржЦржи ржЖржкржирж┐ ржЪрж╛ржЗрж▓рзЗ Portainer, WordPress, ржмрж╛ ржпрзЗржХрзЛржирзЛ ржЕрзНржпрж╛ржкржХрзЗ Ingress ржжрж┐ржпрж╝рзЗ IP-ржП ржПржХрзНрж╕ржкрзЛржЬ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред

**рж╢рзБржн ржХрж╛ржоржирж╛!**
